
# 财务数据中心需求规格说明书 (v3.5)

**项目名称**：Finance Master 集团财务数据中心
**最后更新**：2025-05-23
**状态**：已发布 (迭代 v3.5 - 逻辑修正与体验优化)

---

## 1. 产品愿景

打造一个**“不仅能看账，还能自动对账”**的智能财务工作台。
通过纯前端技术栈，解决集团内多主体（上市/非上市）之间财务数据割裂、关联交易核对繁琐、历史数据难以回溯的问题。让财务人员从 Excel 的 VLOOKUP 中解放出来，专注于经营分析与合规管控。

---

## 2. 核心业务实体

### 2.1 主体架构
系统需支持多主体切换，默认配置：
1.  **上市主体**（中移成都信息通信科技）：作为集团内的**买方/甲方**角色，重点关注成本/费用入账。
2.  **非上市主体**（成研分公司）：作为集团内的**卖方/乙方**角色，重点关注收入确认。

### 2.2 数据模型
*   **Ledger (流水)**：凭证级最细颗粒度数据。
*   **Balance (余额)**：科目级汇总数据。

---

## 3. 功能需求 (Functional Requirements)

### 3.1 数据持久化与管理 (Data Hub)
*   **[已完成] 本地数据库**：使用 IndexedDB 存储导入的财务数据，支持按主体隔离。
*   **[已完成] 导入历史**：记录每次导入的文件名、时间、条数，方便追溯。
*   **[已完成] 状态持久化**：刷新页面后记住当前选择的账套主体。
*   **[已完成] 批次撤销 (Rollback)**：支持按导入批次删除错误数据，无需清空全库。

### 3.2 首页看板与对账 (Dashboard)
*   **[已完成] 经营概览**：基于配置的收入/成本科目，实时计算累计营收、毛利。支持环比 (MoM) 与同比 (YoY) 分析。
*   **[已完成] 关联交易雷达 (Inter-company Radar)**：
    *   **动态对账逻辑**：
        *   **上市主体视角**：自动比对“我方成本 (借方)” vs “对方收入 (贷方)”。
        *   **非上市主体视角**：自动比对“我方收入 (贷方)” vs “对方成本 (借方)”。
    *   **代码级匹配**：优先使用 6 位公司段代码 (Segment Code) 进行关联方识别，名称匹配作为兜底。
*   **[已完成] 月度差异穿透**：点击异常项，弹窗展示逐月对比明细。
*   **[已完成] AI 差异诊断**：集成通义千问 (Qwen)，对月度差异进行宏观分析。
*   **[已完成] 凭证级智能匹配**：支持下钻到具体月份，拉取双方凭证列表，基于金额和摘要进行 AI 勾稽。

### 3.3 报表查询与分析 (Reporting)
*   **[已完成] 余额表多维透视**：支持按“部门”、“客商”动态聚合。
*   **[已完成] 智能字段解析**：导入 CSV/Excel 时，强制优先读取“往来段说明/名称”列，解决以往只显示数字编码的问题。
*   **[已完成] 明细账钻取**：从余额表点击科目，自动跳转至明细账。
*   **[已完成] 导出 Excel**：支持将筛选后的明细账/余额表数据导出为 XLSX 文件。

### 3.4 用户体验与状态管理 (UX)
*   **[已完成] 筛选状态隔离**：
    *   不同主体的筛选条件（期间、关键词、维度开关）相互独立。
    *   切换公司主体时，自动重置或加载该主体上次的筛选状态，防止数据串味。
*   **[已完成] 页面刷新保持**：使用 `sessionStorage` 记录筛选上下文，刷新页面后无需重新输入查询条件。

---

## 4. 待实现功能 (Todo List)

### 4.1 深度对账增强
- [ ] **多币种支持**：针对外币业务，支持汇率折算与本币核对。

### 4.2 报表与可视化
- [ ] **自定义看板**：允许用户配置关注的特定科目指标（如：差旅费、研发费用占比）。

---

## 5. 交互设计原则
*   **Context Aware**：始终提示当前操作主体，通过颜色区分（上市-绿/非上市-蓝），防止录错账。
*   **Strict Isolation**：主体间的数据与操作状态必须严格物理隔离，禁止跨主体的数据泄露。
