
# 财务数据中心需求规格说明书 (v3.7)

**项目名称**：Finance Master 集团财务数据中心
**最后更新**：2025-05-24
**状态**：已发布 (迭代 v3.7 - 体验与智能升级)

---

## 1. 产品愿景

打造一个**“不仅能看账，还能自动对账”**的智能财务工作台。
通过纯前端技术栈，解决集团内多主体（上市/非上市）之间财务数据割裂、关联交易核对繁琐、历史数据难以回溯的问题。让财务人员从 Excel 的 VLOOKUP 中解放出来，专注于经营分析与合规管控。

---

## 2. 核心业务实体

### 2.1 主体架构
系统需支持多主体切换，默认配置：
1.  **上市主体**（中移成都信息通信科技）：作为集团内的**买方/甲方**角色，重点关注成本/费用入账。
2.  **非上市主体**（成研分公司）：作为集团内的**卖方/乙方**角色，重点关注收入确认。

### 2.2 数据模型
*   **Ledger (流水)**：凭证级最细颗粒度数据。
*   **Balance (余额)**：科目级汇总数据，支持“上年同期期末余额”字段。

---

## 3. 功能需求 (Functional Requirements)

### 3.1 数据持久化与管理 (Data Hub)
*   **[已完成] 本地数据库**：使用 IndexedDB 存储导入的财务数据，支持按主体隔离。
*   **[已完成] 导入历史**：记录每次导入的文件名、时间、条数，方便追溯。
*   **[已完成] 状态持久化**：刷新页面后记住当前选择的账套主体。
*   **[已完成] 批次撤销 (Rollback)**：支持按导入批次删除错误数据，无需清空全库。

### 3.2 首页看板与对账 (Dashboard)
*   **[已完成] 经营概览**：基于配置的收入/成本科目，实时计算累计营收、毛利。支持环比 (MoM) 与同比 (YoY) 分析。
*   **[已完成] 关联交易雷达**：动态切换“成本 vs 收入”方向，基于代码与名称智能匹配。
*   **[已完成] 智能异常检测 (Anomaly Detection)**：
    *   **现状**：系统集成通义千问 AI。
    *   **功能**：在数据导入后或查看看板时，点击“AI 异常检测”，后台自动分析月度财务趋势。
    *   **场景**：如果某个月的“办公费”比过去平均值高出 50%，或利润率出现负值，系统会自动标记并生成诊断报告：“本月成本异常波动，建议核查”。
*   **[已完成] 凭证级智能匹配**：支持下钻到具体月份，拉取双方凭证列表，基于金额和摘要进行 AI 勾稽。

### 3.3 报表查询与分析 (Reporting)
*   **[已完成] 余额表多维透视**：支持按“部门”、“客商”动态聚合。
*   **[已完成] 余额表同比分析**：支持解析并展示“上年同期期末余额”，辅助进行年度对比。
*   **[已完成] 树状交互优化**：实现了递归折叠逻辑，保持视图整洁。
*   **[已完成] 凭证深度还原**：在明细账中点击“凭证号”，聚合显示该凭证下的**所有分录**（借贷方全貌），检查借贷平衡。

### 3.4 用户体验与状态管理 (UX)
*   **[已完成] 筛选状态隔离**：不同主体的筛选条件相互独立且持久化。
*   **[已完成] 固定表头 (Sticky Headers)**：优化全站表格布局，支持大数据量滚动。

---

## 4. 后续规划 (v4.0 - 智能化深度集成与性能优化)

### 4.1 深度 AI 交互 (Intelligence)
- [ ] **自然语言查询 (Natural Language Query)**：
    - **痛点**：现在的筛选需要选月份、输科目代码、输关键词，步骤多且对非专业人士不友好。
    - **方案**：在顶部增加一个 AI 输入框。
    - **场景**：用户输入“*帮我看看上个月研发部有哪些超过 10 万的差旅费？*”
    - **实现**：AI 将自然语言转换为查询条件 (e.g., `Department='研发' AND Subject='差旅' AND Amount>100000`)，直接过滤出结果。

### 4.2 性能极致优化 (Performance)
- [x] **Web Workers 异步解析**：**[已完成 v4.0]**
    - **痛点**：Excel 解析在主线程运行。如果文件超过 5MB 或 5万行，页面会卡死几秒。
    - **实现**：将 xlsx 解析逻辑移至 Web Worker 后台线程。
    - **效果**：保持 UI 始终流畅，并支持大文件无感导入。

### 4.3 报表灵活性 (Flexibility)
- [ ] **自定义分组 (Dynamic Grouping)**：
    - 支持用户拖拽维度，实现“部门 -> 科目”或“客商 -> 科目”的倒置树状分析。

---

## 5. 交互设计原则
*   **Context Aware**：始终提示当前操作主体，通过颜色区分（上市-绿/非上市-蓝）。
*   **Strict Isolation**：主体间的数据与操作状态必须严格物理隔离。
